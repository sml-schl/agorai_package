# Automated Counterfactual Testing Configuration
# This file configures the automated testing pipeline for causal robustness evaluation

# Protected Attribute Detector Configuration
detector:
  # Vision-Language Model for attribute detection
  vlm_model: "gpt-4-vision-preview"  # or "gpt-4o", "claude-3-opus-20240229", etc.
  vlm_provider: "openai"  # or "anthropic"

  # Detection parameters
  confidence_threshold: 0.6  # Minimum confidence to consider an attribute detected (0.0-1.0)

  # API configuration
  api_key_env: "OPENAI_API_KEY"  # Environment variable for API key

# Counterfactual Generator Configuration
generator:
  # Image generation tool
  tool: "dall-e-3"  # Options: "dall-e-3", "stable-diffusion-xl", "replicate"

  # Provider (for Stable Diffusion)
  provider: "replicate"  # Options: "replicate", "huggingface" (only for SD)

  # API configuration
  api_key_env: "OPENAI_API_KEY"  # For DALL-E 3
  # api_key_env: "REPLICATE_API_TOKEN"  # For Replicate
  # api_key_env: "HUGGINGFACE_API_KEY"  # For HuggingFace

  # Generation parameters
  default_params:
    quality: "standard"  # DALL-E 3: "standard" or "hd"
    size: "1024x1024"  # Image size
    # For Stable Diffusion:
    # guidance_scale: 7.5
    # strength: 0.7  # How much to modify (0.0-1.0)

# Automated Testing Configuration
testing:
  # Attribute testing limits
  max_attributes_to_test: 3  # Maximum protected attributes to test per image
  max_variations_per_attribute: 2  # Maximum counterfactuals per attribute

  # Thresholds
  consistency_threshold: 0.8  # Minimum % of counterfactuals that should be consistent
  significant_confidence_delta: 0.2  # What counts as a significant confidence change

  # Rate limiting
  generation_delay_seconds: 1.0  # Delay between generation requests

  # Evaluation settings
  evaluation_prompt_template: |
    Classify this image as hateful or not hateful.
    {text_content}
    Respond with your classification and confidence.

# Image Generation Tool URLs (for different providers)
image_generation_urls:
  openai_dalle3: "https://api.openai.com/v1/images/generations"
  replicate_sdxl: "https://replicate.com/stability-ai/sdxl"
  huggingface_sdxl: "https://api-inference.huggingface.co/models/stabilityai/stable-diffusion-xl-base-1.0"

  # Local deployment (optional)
  # local_sd: "http://localhost:7860/sdapi/v1/txt2img"

# Protected Attributes to Focus On
protected_attributes_priority:
  # High priority (always test)
  - ethnicity
  - gender
  - skin_tone
  - religious_symbols

  # Medium priority (test if detected)
  - age
  - clothing_style
  - cultural_symbols

  # Low priority (optional)
  - socioeconomic_indicators
  - ability_status
  - body_type

# Counterfactual Variations
# Predefined variations for each attribute type
predefined_variations:
  ethnicity:
    african: ["european", "asian", "middle_eastern"]
    european: ["african", "asian", "middle_eastern"]
    asian: ["african", "european", "middle_eastern"]
    middle_eastern: ["african", "european", "asian"]

  gender:
    male: ["female", "non-binary"]
    female: ["male", "non-binary"]

  age:
    young_adult: ["middle_aged", "elderly"]
    middle_aged: ["young_adult", "elderly"]
    elderly: ["young_adult", "middle_aged"]

  skin_tone:
    light: ["medium", "dark"]
    medium: ["light", "dark"]
    dark: ["light", "medium"]

  religious_symbols:
    hijab: ["christian_cross", "no_religious_symbol"]
    christian_cross: ["hijab", "no_religious_symbol"]
    jewish_kippah: ["hijab", "no_religious_symbol"]

# Output Configuration
output:
  # Where to save results
  results_directory: "./counterfactual_test_results"

  # Result file format
  result_format: "json"  # Options: "json", "csv", "both"

  # Save generated images
  save_counterfactual_images: true
  images_directory: "./counterfactual_images"

  # Logging
  log_level: "INFO"  # Options: "DEBUG", "INFO", "WARNING", "ERROR"
  log_file: "./counterfactual_testing.log"

# Batch Processing
batch:
  # Parallel processing
  max_parallel_tests: 1  # Number of tests to run in parallel (careful with API rate limits)

  # Resume capability
  checkpoint_interval: 5  # Save progress every N tests
  checkpoint_file: "./test_checkpoint.json"

  # Error handling
  max_retries: 3  # Number of retries for failed API calls
  retry_delay_seconds: 5  # Delay between retries

# Advanced Settings
advanced:
  # Image preservation settings
  preserve_composition: true  # Keep overall layout unchanged
  preserve_style: true  # Keep artistic style unchanged
  preserve_background: true  # Keep background unchanged

  # Quality control
  min_image_quality_score: 0.7  # Minimum quality for generated images (if available)

  # Filtering
  skip_low_confidence_attributes: true  # Skip attributes below confidence threshold
  skip_ambiguous_images: false  # Skip images with no clear protected attributes
